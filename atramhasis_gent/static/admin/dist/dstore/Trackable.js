//>>built
define("dstore/Trackable","dojo/_base/lang dojo/_base/declare dojo/aspect dojo/when dojo/promise/all dojo/_base/array dojo/on".split(" "),function(C,y,G,A,p,D,H){function E(h,l,t){for(var r=h.length-1;0<=r;--r){var n=h[r],x=n.start,n=x+n.count;if(l>n){h.splice(r+1,0,{start:l,count:t-l});return}t>=x&&(l=Math.min(l,x),t=Math.max(t,n),h.splice(r,1))}h.unshift({start:l,count:t-l})}var I=0,B={track:function(){function h(){return function(){var c=this,a=this.inherited(arguments);A(a,function(a){a=c._results=
a.slice();c._partialResults&&(c._partialResults=null);c._ranges=[];E(c._ranges,0,a.length)});return a}}function l(){return function(c){var a=this,d=c.start,g=c.end,e=this.inherited(arguments);this._results||A(e,function(b){return A(b.totalLength,function(c){var e=a._partialResults||(a._partialResults=[]);g=Math.min(g,d+b.length);e.length=c;c=[d,g-d].concat(b);e.splice.apply(e,c);E(a._ranges,d,g);return b})});return e}}function t(c,a){I++;var d=a.target;a=C.delegate(a,B[c]);var g=a.beforeId;A(s._results||
s._partialResults,function(e){if(e){var b,f,h,m=s._ranges,k,l="id"in a?a.id:r.getIdentity(d),n=-1,u=-1,q=-1,v=-1,p;if("delete"===c||"update"===c)for(b=0;-1===n&&b<m.length;++b){k=m[b];f=k.start;for(h=f+k.count;f<h;++f)if(r.getIdentity(e[f])==l){n=a.previousIndex=f;u=b;p=g==l;e.splice(n,1);k.count--;for(f=b+1;f<m.length;++f)m[f].start--;break}}if("add"===c||"update"===c){if(z){if(z([d]).length){var w=0;h=m.length-1;for(p=-1;w<=h&&-1===q;)b=w+Math.round((h-w)/2),k=m[b],u=e.slice(k.start,k.start+k.count),
void 0!==g&&(p=null===g?u.length:F(u,g)),-1===p&&(p=n>=Math.max(0,k.start-1)&&n<=k.start+k.count?n:r.defaultNewToStart?0:u.length),u.splice(p,0,d),f=D.indexOf(z(u),d),l=k.start+f,0===f&&0!==k.start?h=b-1:f>=u.length-1&&l<e.length?w=b+1:(q=l,v=b);if(-1===q&&0<w&&w<m.length)var t=!0}}else{f=-1;if(void 0!==g&&!p)if(null===g)q=e.length,f=m.length-1;else{b=0;for(h=m.length;-1===v&&b<h;++b)k=m[b],q=F(e,g,k.start,k.start+k.count),-1!==q&&(v=b)}else"update"===c?(q=n,v=u):r.defaultNewToStart?f=q=0:(q=e.length,
f=m.length-1);-1!==f&&-1===v&&(k=m[f])&&(k.start<=q&&q<=k.start+k.count)&&(v=f)}if(-1<q&&-1<v){a.index=q;e.splice(q,0,d);m[v].count++;for(b=v+1;b<m.length;++b)m[b].start++}else if(t){a.beforeIndex=m[w].start;for(b=w;b<m.length;++b)m[b].start++}}a.totalLength=e.length}(e=s["on_tracked"+c])&&e.call(s,a)})}var r=this.store||this,n=[],x={add:1,update:1,"delete":1},p;for(p in x)n.push(this.on(p,function(c){return function(a){t(c,a)}}(p)));var s=y.safeMixin(C.delegate(this),{_ranges:[],fetch:h(),fetchRange:l(),
releaseRange:function(c,a){if(this._partialResults){a:for(var d=this._ranges,g=0,e;e=d[g];++g){var b=e.start,f=b+e.count;if(c<=b)if(a>=f)d.splice(g,1);else{e.start=a;e.count=f-e.start;break a}else if(c<f)if(a>b){d.splice(g,1,{start:b,count:c-b},{start:a,count:f-a});break a}else e.count=c-e.start}for(d=c;d<a;++d)delete this._partialResults[d]}},on:function(c,a){var d=this,g=this.getInherited(arguments);return H.parse(s,c,a,function(c,b){return b in x?G.after(s,"on_tracked"+b,a,!0):g.call(d,b,a)})},
tracking:{remove:function(){for(;0<n.length;)n.pop().remove();this.remove=function(){}}},track:null});this.fetchSync&&(y.safeMixin(s,{fetchSync:h(),fetchRangeSync:l()}),s.fetchSync());var z;D.forEach(this.queryLog,function(c){var a=z,d=c.querier;d&&(z=a?function(c){return d(a(c))}:d)});var B={add:{index:void 0},update:{previousIndex:void 0,index:void 0},"delete":{previousIndex:void 0}},F=function(c,a,d,g){g=void 0!==g?g:c.length;for(d=void 0!==d?d:0;d<g;++d)if(r.getIdentity(c[d])===a)return d;return-1};
return s}};p=y(null,B);p.create=function(h,l){h=y.safeMixin(C.delegate(h),B);y.safeMixin(h,l);return h};return p});
//# sourceMappingURL=Trackable.js.map