//>>built
define("dgrid/OnDemandList","./List ./_StoreMixin dojo/_base/declare dojo/_base/lang dojo/dom-construct dojo/on dojo/when ./util/misc".split(" "),function(B,C,D,E,q,v,F,t){return D([B,C],{minRowsPerPage:25,maxRowsPerPage:250,maxEmptySpace:Infinity,bufferRows:10,farOffRemoval:2E3,queryRowsOverlap:0,pagingMethod:"debounce",pagingDelay:t.defaultDelay,keepScrollPosition:!1,rowHeight:0,postCreate:function(){this.inherited(arguments);var c=this;v(this.bodyNode,"scroll",t[this.pagingMethod](function(f){c._processScroll(f)},
null,this.pagingDelay))},destroy:function(){this.inherited(arguments);this._refreshTimeout&&clearTimeout(this._refreshTimeout)},renderQuery:function(c,f){var h=this,l=f&&f.container||this.contentNode,b={query:c,count:0},k,r=this.preload,g={node:q.create("div",{className:"dgrid-preload",style:{height:"0"}},l),count:0,query:c,next:b};g.node.rowIndex=0;b.node=k=q.create("div",{className:"dgrid-preload"},l);b.previous=g;k.rowIndex=this.minRowsPerPage;r?((b.next=r.next)&&k.offsetTop>=r.node.offsetTop?
b.previous=r:(b.next=r,b.previous=r.previous),b.previous.next=b,b.next.previous=b):this.preload=b;var a=q.create("div",{className:"dgrid-loading"},k,"before");q.create("div",{className:"dgrid-below"},a).innerHTML=this.loadingMessage;f=E.mixin({start:0,count:this.minRowsPerPage},"level"in c?{queryLevel:c.level}:null);return this._trackError(function(){var g=c(f);return h.renderQueryResults(g,k,f).then(function(c){return g.totalLength.then(function(g){var l=c.length,n=k.parentNode,d=h.noDataNode;h._rows&&
(h._rows.min=0,h._rows.max=l===g?Infinity:l-1);q.destroy(a);"queryLevel"in f||(h._total=g);0===g&&n&&(d&&(q.destroy(d),delete h.noDataNode),h.noDataNode=d=q.create("div",{className:"dgrid-no-data",innerHTML:h.noDataMessage}),n.insertBefore(d,h._getFirstRowSibling(n)));for(d=n=0;d<l;d++)n+=h._calcRowHeight(c[d]);l&&n&&(h.rowHeight=n/l);g-=l;b.count=g;k.rowIndex=l;g?k.style.height=Math.min(g*h.rowHeight,h.maxEmptySpace)+"px":k.style.display="none";h._previousScrollPosition&&(h.scrollTo(h._previousScrollPosition),
delete h._previousScrollPosition);return F(h._processScroll()).then(function(){return c})})}).otherwise(function(b){q.destroy(a);throw b;})})},refresh:function(c){var f=this,h=c&&c.keepScrollPosition;"undefined"===typeof h&&(h=this.keepScrollPosition);h&&(this._previousScrollPosition=this.getScrollPosition());this.inherited(arguments);if(this._renderedCollection)return this.renderQuery(function(c){return f._renderedCollection.fetchRange({start:c.start,end:c.start+c.count})}).then(function(){f._refreshTimeout=
setTimeout(function(){v.emit(f.domNode,"dgrid-refresh-complete",{bubbles:!0,cancelable:!1,grid:f});f._refreshTimeout=null},0)})},resize:function(){this.inherited(arguments);this._processScroll()},cleanup:function(){this.inherited(arguments);this.preload=null},renderQueryResults:function(c){var f=this.inherited(arguments),h=this._renderedCollection;h&&h.releaseRange&&f.then(function(f){f[0]&&!f[0].parentNode.tagName&&c.totalLength.then(function(){h.releaseRange(f[0].rowIndex,f[f.length-1].rowIndex+
1)})});return f},_getFirstRowSibling:function(c){return c.lastChild},_calcRowHeight:function(c){var f=c.nextSibling;return f&&!/\bdgrid-preload\b/.test(f.className)?f.offsetTop-c.offsetTop:c.offsetHeight},lastScrollTop:0,_processScroll:function(c){function f(a,c,d,f){var g=b.farOffRemoval,e=a.node;if(c>2*g){for(var k,l=e[d],m=0,n=0,p=[],r=l&&l.rowIndex,s;k=l;){var t=b._calcRowHeight(k);if(m+t+g>c||0>l.className.indexOf("dgrid-row")&&0>l.className.indexOf("dgrid-loading"))break;l=k[d];m+=t;n+=k.count||
1;b.removeRow(k,!0);p.push(k);"rowIndex"in k&&(s=k.rowIndex)}b._renderedCollection.releaseRange&&("number"===typeof r&&"number"===typeof s)&&(f?b._renderedCollection.releaseRange(s,r+1):b._renderedCollection.releaseRange(r,s+1),b._rows[f?"max":"min"]=s,b._rows.max>=b._total-1&&(b._rows.max=Infinity));a.count+=n;f?(e.rowIndex-=n,h(a)):e.style.height=e.offsetHeight+m+"px";var u=document.createElement("div");for(a=p.length;a--;)u.appendChild(p[a]);setTimeout(function(){q.destroy(u)},1)}}function h(a,
c){a.node.style.height=Math.min(a.count*b.rowHeight,c?Infinity:b.maxEmptySpace)+"px"}function l(b,a){do b=a?b.next:b.previous;while(b&&!b.node.offsetWidth);return b}if(this.rowHeight){var b=this,k=b.bodyNode;c=c&&c.scrollTop||this.getScrollPosition().y;var k=k.offsetHeight+c,r,g,a=b.preload,v=b.lastScrollTop,x=b.bufferRows*b.rowHeight,t=x-b.rowHeight,A,n=!0;for(b.lastScrollTop=c;a&&!a.node.offsetWidth;)a=a.previous;for(;a&&a!==r;){r=b.preload;b.preload=a;g=a.node;var d=g.offsetTop;if(k+1+t<d)a=l(a,
n=!1);else if(c-1-t>d+g.offsetHeight)a=l(a,n=!0);else{var d=((g.rowIndex?c-x:k)-d)/b.rowHeight,e=(k-c+2*x)/b.rowHeight,s=Math.max(Math.min((c-v)*b.rowHeight,b.maxRowsPerPage/2),b.maxRowsPerPage/-2),e=e+Math.min(Math.abs(s),10);0===g.rowIndex&&(d-=e);d=Math.max(d,0);10>d&&(0<d&&e+d<b.maxRowsPerPage)&&(e+=Math.max(0,d),d=0);e=Math.min(Math.max(e,b.minRowsPerPage),b.maxRowsPerPage,a.count);if(0===e)a=l(a,n);else{var e=Math.ceil(e),d=Math.min(Math.floor(d),a.count-e),m={};a.count-=e;var p=g,w,s=b.queryRowsOverlap,
y=(0<g.rowIndex||g.offsetTop>c)&&a;if(y){var u=a.previous;u&&(f(u,c-(u.node.offsetTop+u.node.offsetHeight),"nextSibling"),0<d&&u.node===g.previousSibling?(d=Math.min(a.count,d),a.previous.count+=d,h(a.previous,!0),g.rowIndex+=d,s=0):e+=d,a.count-=d);m.start=g.rowIndex-s;m.count=Math.min(e+s,b.maxRowsPerPage);g.rowIndex=m.start+m.count}else a.next&&(f(a.next,a.next.node.offsetTop-k,"previousSibling",!0),p=g.nextSibling,p===a.next.node?(a.next.count+=a.count-d,a.next.node.rowIndex=d+e,h(a.next),a.count=
d,s=0):w=!0),m.start=a.count,m.count=Math.min(e+s,b.maxRowsPerPage);w&&(p&&p.offsetWidth)&&(w=p.offsetTop);h(a);"level"in a.query&&(m.queryLevel=a.query.level);if("queryLevel"in m||!(m.start>b._total||0>m.count)){var z=q.create("div",{className:"dgrid-loading",style:{height:e*b.rowHeight+"px"}},p,"before");q.create("div",{className:"dgrid-"+(y?"below":"above"),innerHTML:b.loadingMessage},z);z.count=e;b._trackError(function(){(function(c,d,f){var g=a.query(m);A=b.renderQueryResults(g,c,m).then(function(a){var e=
b._rows;e&&(!("queryLevel"in m)&&a.length)&&(d?(e.max<=e.min&&(e.min=a[0].rowIndex),e.max=a[a.length-1].rowIndex):(e.max<=e.min&&(e.max=a[a.length-1].rowIndex),e.min=a[0].rowIndex));p=c.nextSibling;q.destroy(c);f&&(p&&p.offsetWidth)&&(e=b.getScrollPosition(),b.scrollTo({x:e.x,y:e.y+p.offsetTop-f,preserveMomentum:!0}));g.totalLength.then(function(a){"queryLevel"in m||(b._total=a,b._rows&&b._rows.max>=b._total-1&&(b._rows.max=Infinity));d&&(d.count=a-d.node.rowIndex,h(d))});b._processScroll();return a},
function(a){q.destroy(c);throw a;})})(z,y,w)});a=a.previous}}}}return A}}})});
//# sourceMappingURL=OnDemandList.js.map