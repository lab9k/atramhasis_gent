//>>built
define("dgrid/Editor","dojo/_base/declare dojo/_base/lang dojo/Deferred dojo/dom-construct dojo/dom-class dojo/on dojo/has dojo/query ./Grid dojo/_base/sniff".split(" "),function(u,p,q,r,s,m,t,v,w){return u(null,{constructor:function(){this._editorInstances={};this._editorColumnListeners=[];this._editorCellListeners={};this._editorsPendingStartup=[]},postCreate:function(){var a=this;this.inherited(arguments);this.on(".dgrid-input:focusin",function(){a._focusedEditorCell=a.cell(this)});this._editorFocusoutHandle=
m.pausable(this.domNode,".dgrid-input:focusout",function(){a._focusedEditorCell=null});this._listeners.push(this._editorFocusoutHandle)},insertRow:function(){this._editorRowListeners={};var a=this.inherited(arguments),c=this.row(a),b=this._editorCellListeners[a.id]=this._editorCellListeners[a.id]||{},d;for(d in this._editorRowListeners)b[d]=this._editorRowListeners[d];this._editorRowListeners=null;(b=this._previouslyFocusedEditorCell)&&b.row.id===c.id&&this.edit(this.cell(c,b.column.id));return a},
refresh:function(){for(var a in this._editorInstances){var c=this._editorInstances[a].domNode;c&&c.parentNode&&c.parentNode.removeChild(c)}this.inherited(arguments)},removeRow:function(a){var c=this,b=this._focusedEditorCell;b&&b.row.id===this.row(a).id&&(this._previouslyFocusedEditorCell=b,this._editorFocusoutHandle.pause(),setTimeout(function(){c._editorFocusoutHandle.resume();c._previouslyFocusedEditorCell=null},0));if(this._editorCellListeners[a.id]){for(var d in this._editorCellListeners[a.id])this._editorCellListeners[a.id][d].remove();
delete this._editorCellListeners[a.id]}for(b=this._alwaysOnWidgetColumns.length;b--;)if(d=(d=this.cell(a,this._alwaysOnWidgetColumns[b].id).element)&&(d.contents||d).widget)this._editorFocusoutHandle.pause(),d.destroyRecursive();return this.inherited(arguments)},renderArray:function(){var a=this.inherited(arguments);a.length?this._startupPendingEditors():this._editorsPendingStartup=[];return a},_onNotification:function(){this.inherited(arguments);this._startupPendingEditors()},_destroyColumns:function(){this._editorStructureCleanup();
this.inherited(arguments)},_editorStructureCleanup:function(){var a=this._editorInstances,c=this._editorColumnListeners;this._editTimer&&clearTimeout(this._editTimer);for(var b in a){var d=a[b];d.domNode&&d.destroyRecursive()}this._editorInstances={};for(a=c.length;a--;)c[a].remove();for(var g in this._editorCellListeners)for(b in this._editorCellListeners[g])this._editorCellListeners[g][b].remove();for(a=0;a<this._editorColumnListeners.length;a++)this._editorColumnListeners[a].remove();this._editorCellListeners=
{};this._editorColumnListeners=[];this._editorsPendingStartup=[]},_configColumns:function(){var a=this.inherited(arguments);this._alwaysOnWidgetColumns=[];for(var c=0,b=a.length;c<b;c++)a[c].editor&&this._configureEditorColumn(a[c]);return a},_configureEditorColumn:function(a){var c=this,b=a.renderCell||this._defaultRenderCell,d=a.editOn,g="string"!==typeof a.editor;d?this._editorInstances[a.id]=this._createSharedEditor(a,b):g&&this._alwaysOnWidgetColumns.push(a);a.renderCell=d?function(k,g,e,f){if(!f||
!f.alreadyHooked){var l=m(e,d,function(){c._activeOptions=f;c.edit(this)});if(c._editorRowListeners)c._editorRowListeners[a.id]=l;else{var n=c.row(k);c._editorCellListeners[n.element.id][a.id]=l}}return b.call(a,k,g,e,f)}:function(d,h,e,f){if(!a.canEdit||a.canEdit(d,h))d=c._createEditor(a,d),c._showEditor(d,a,e,h),e[g?"widget":"input"]=d;else return b.call(a,d,h,e,f)}},edit:function(a){function c(a){b._activeCell=g;b._showEditor(f,d,g,e);b._editTimer=setTimeout(function(){f.focus&&f.focus();d._editorBlurHandle&&
d._editorBlurHandle.resume();b._editTimer=null;a.resolve(f)},0)}var b=this,d,g,k,h,e,f,l;a.column||(a=this.cell(a));if(!a||!a.element)return null;d=a.column;h=d.field;g=a.element.contents||a.element;if(f=this._editorInstances[d.id]){if(this._activeCell!==g){var n=a.row;e=(k=this.dirty&&this.dirty[n.id])&&h in k?k[h]:d.get?d.get(n.data):n.data[h];if(!d.canEdit||d.canEdit(a.row.data,e))return l=new q,a=f.domNode||f,a.offsetWidth?(a.blur(),setTimeout(function(){c(l)},0)):c(l),l.promise}}else if(d.editor&&
(f=g.widget||g.input))return l=new q,f.focus&&f.focus(),l.resolve(f),l.promise;return null},refreshCell:function(a){var c=a.row.element.id,b=a.column.id;this._editorCellListeners[c]&&this._editorCellListeners[c][b]&&(this._editorCellListeners[c][b].remove(),this._editorCellListeners[c][b]=null);return this.inherited(arguments)},_showEditor:function(a,c,b,d){var g=a.domNode;g||this._updateInputValue(a,d);b.innerHTML="";s.add(b,"dgrid-cell-editing");g&&(c.editOn&&a.validate&&a.reset)&&a.reset();b.appendChild(a.domNode||
a);g&&!c.editOn?this._editorsPendingStartup.push([a,c,b,d]):this._startupEditor(a,c,b,d)},_startupEditor:function(a,c,b,d){a.domNode&&(a._started||a.startup(),a._dgridIgnoreChange=!0,a.set("value",d),setTimeout(function(){a._dgridIgnoreChange=!1},0));a._dgridLastValue=d;this._activeCell&&(this._activeValue=d,m.emit(b,"dgrid-editor-show",{grid:this,cell:this.cell(b),column:c,editor:a,bubbles:!0,cancelable:!1}))},_startupPendingEditors:function(){for(var a=this._editorsPendingStartup,c=a.length;c--;)this._startupEditor.apply(this,
a[c]);this._editorsPendingStartup=[]},_handleEditorChange:function(a,c){var b=a.target;"_dgridLastValue"in b&&-1<b.className.indexOf("dgrid-input")&&this._updatePropertyFromEditor(c||this.cell(b).column,b,a)},_createEditor:function(a,c){var b=a.editor,d=a.editOn,g=this,k="string"!==typeof b&&b,h,e,f={};h=a.editorArgs||{};"function"===typeof h&&(h=h.call(this,a));k?(e=new k(h),h=e.focusNode||e.domNode,h.className+=" dgrid-input",e.on(d?"blur":"change",function(){e._dgridIgnoreChange||g._updatePropertyFromEditor(a,
this,{type:"widget"})})):(this._hasInputListener||(this._hasInputListener=!0,this.on("change",function(a){g._handleEditorChange(a)})),"textarea"===b?k="textarea":(k="input",f.type=b),e=h=r.create(k,p.mixin(f,{className:"dgrid-input",name:a.field,tabIndex:isNaN(a.tabIndex)?-1:a.tabIndex},h)),9>t("ie")&&(b="radio"===b||"checkbox"===b?m(e,"click",function(b){g._handleEditorChange(b,a)}):m(e,"change",function(b){g._handleEditorChange(b,a)}),d?this._editorColumnListeners.push(b):this._editorRowListeners?
this._editorRowListeners[a.id]=b:this._editorCellListeners[this.row(c).element.id][a.id]=b));if(a.autoSelect){var l=e.focusNode||e;l.select&&m(l,"focus",function(){setTimeout(function(){l.select()},0)})}return e},_createSharedEditor:function(a){function c(){var a=d._activeCell;h.blur();"function"===typeof d.focus&&setTimeout(function(){d.focus(a)},g&&9>t("ie")?15:0)}var b=this._createEditor(a),d=this,g=b.domNode,k=b.domNode||b,h=b.focusNode||k,e=g?function(){b.set("value",b._dgridLastValue)}:function(){d._updateInputValue(b,
b._dgridLastValue);d._updatePropertyFromEditor(a,b)};this._editorColumnListeners.push(m(h,"keydown",function(f){f=f.keyCode||f.which;27===f?(e(),d._activeValue=b._dgridLastValue,c()):13===f&&!1!==a.dismissOnEnter&&c()}));(a._editorBlurHandle=m.pausable(b,"blur",function(){var c=k.parentNode,g={alreadyHooked:!0},e=d.cell(k);m.emit(e.element,"dgrid-editor-hide",{grid:d,cell:e,column:a,editor:b,bubbles:!0,cancelable:!1});a._editorBlurHandle.pause();c.removeChild(k);e.row&&(s.remove(e.element,"dgrid-cell-editing"),
r.empty(c),w.appendIfNode(c,a.renderCell(e.row.data,d._activeValue,c,d._activeOptions?p.delegate(g,d._activeOptions):g)));d._focusedEditorCell=d._activeCell=d._activeValue=d._activeOptions=null})).pause();this._editorColumnListeners.push(a._editorBlurHandle);return b},_updatePropertyFromEditor:function(a,c,b){var d;if(!c.isValid||c.isValid())if(b=this._updateProperty((c.domNode||c).parentNode,this._activeCell?this._activeValue:c._dgridLastValue,this._retrieveEditorValue(a,c),b),this._activeCell?this._activeValue=
b:c._dgridLastValue=b,"radio"===c.type&&c.name&&!a.editOn&&a.field)for(d in b=this.row(c),v("input[type\x3dradio][name\x3d"+c.name+"]",this.contentNode).forEach(function(b){var d=this.row(b);b!==c&&b._dgridLastValue&&(b._dgridLastValue=!1,this.updateDirty?this.updateDirty(d.id,a.field,!1):d.data[a.field]=!1)},this),this.dirty)b.id.toString()!==d&&this.dirty[d][a.field]&&this.updateDirty(d,a.field,!1)},_updateProperty:function(a,c,b,d){var g=this;if((c&&c.valueOf())!==(b&&b.valueOf())){var k=this.cell(a),
h=k.row,e=k.column;a=k.element;if(e.field&&h)if(k={grid:this,cell:k,oldValue:c,value:b,bubbles:!0,cancelable:!0},d&&d.type&&(k.parentType=d.type),m.emit(a,"dgrid-datachange",k))this.updateDirty?(this.updateDirty(h.id,e.field,b),e.autoSave&&setTimeout(function(){g._trackError("save")},0)):h.data[e.field]=b;else{var f;(f=a.widget)?(f._dgridIgnoreChange=!0,f.set("value",c),setTimeout(function(){f._dgridIgnoreChange=!1},0)):(f=a.input)&&this._updateInputValue(f,c);return c}}return b},_updateInputValue:function(a,
c){a.value=c;if("radio"===a.type||"checkbox"===a.type)a.checked=a.defaultChecked=!!c},_retrieveEditorValue:function(a,c){return"function"===typeof c.get?this._convertEditorValue(c.get("value")):this._convertEditorValue(c["checkbox"===c.type||"radio"===c.type?"checked":"value"])},_convertEditorValue:function(a,c){if("number"===typeof c)a=isNaN(a)?a:parseFloat(a);else if("boolean"===typeof c)a="true"===a?!0:"false"===a?!1:a;else if(c instanceof Date){var b=new Date(a);a=isNaN(b.getTime())?a:b}return a}})});
//# sourceMappingURL=Editor.js.map